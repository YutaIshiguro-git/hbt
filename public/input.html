<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOT Device Admin Panel</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container-input">
        <div class="container-top">
            <h1>IOT Device Registration Panel</h1>

            <!-- メニューリンクを追加 -->
            <nav class="menu">
                <a href="index.html">Top</a> |
                <a href="input.html">Unit Registration</a> |
                <a href="list.html">Unit List</a>
            </nav>
        </div>
        <form id="adminForm">
            <div class="form-group">
                <label for="unitName">UNIT_NAME</label>
                <select id="unitName" name="unitName" required onchange="populateData()">
                    <option value="">Select UNIT_NAME</option>
                    <!-- Populate options dynamically -->
                    <script>
                        for (let i = 1; i <= 16; i++) {
                            const unit = i.toString().padStart(2, '0');
                            document.write(`<option value="UNIT${unit}">UNIT${unit}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="form-group">
                <label for="moistureLevel">MOISTURE_LEVEL</label>
                <input type="number" id="moistureLevel" name="moistureLevel" required />
            </div>
            <div class="form-group">
                <label for="pinNumber">PIN_NUMBER</label>
                <input type="number" id="pinNumber" name="pinNumber" required />
            </div>
            <div class="form-group">
                <label for="adcChannel">ADC_CHANNEL</label>
                <input type="number" id="adcChannel" name="adcChannel" required />
            </div>
            <div class="form-group">
                <label for="plantName">PLANT_NAME</label>
                <input type="text" id="plantName" name="plantName" />
            </div>
            <div class="form-group">
                <label for="plantDescription">PLANT_DESCRIPTION</label>
                <textarea id="plantDescription" name="plantDescription"></textarea>
            </div>
            <button type="button" onclick="saveData()">Save</button>
        </form>
    </div>

    <!-- JavaScriptの挿入 -->
    <script>
        let isExistingRecord = false; // Flag to track if UNIT_NAME already exists

        async function populateData() {
            const unitName = document.getElementById('unitName').value;
            if (!unitName) {
                clearForm();
                isExistingRecord = false;
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/plants'); // Fetch all data
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const dataArray = await response.json(); // Assume array of objects

                // Find the matching record
                const matchingData = dataArray.find(item => item.UNIT_NAME === unitName);

                if (matchingData) {
                    updateFormFields(matchingData); // Update form fields with the matching data
                    console.log('Loaded Data:', matchingData); // Display the loaded data in console
                    isExistingRecord = true; // Mark as existing record
                } else {
                    clearForm();
                    isExistingRecord = false; // Mark as new record
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to fetch data. Please try again later.');
            }
        }

        function updateFormFields(data) {
            // Explicitly update form fields to ensure rendering
            document.getElementById('moistureLevel').value = data.MOISTURE_LEVEL || '';
            document.getElementById('pinNumber').value = data.PIN_NUMBER || '';
            document.getElementById('adcChannel').value = data.ADC_CHANNEL || '';
            document.getElementById('plantName').value = data.PLANT_NAME || '';
            document.getElementById('plantDescription').value = data.PLANT_DESCRIPTION || '';
        }

        function clearForm() {
            document.getElementById('moistureLevel').value = '';
            document.getElementById('pinNumber').value = '';
            document.getElementById('adcChannel').value = '';
            document.getElementById('plantName').value = '';
            document.getElementById('plantDescription').value = '';
        }

        function saveData() {
            const data = {
                UNIT_NAME: document.getElementById('unitName').value,
                MOISTURE_LEVEL: parseInt(document.getElementById('moistureLevel').value, 10),
                PIN_NUMBER: parseInt(document.getElementById('pinNumber').value, 10),
                ADC_CHANNEL: parseInt(document.getElementById('adcChannel').value, 10),
                PLANT_NAME: document.getElementById('plantName').value,
                PLANT_DESCRIPTION: document.getElementById('plantDescription').value
            };

            // バリデーションチェック
            if (!data.UNIT_NAME) {
                alert('Please select a UNIT_NAME.');
                return;
            }

            console.log('Saved Data:', data);

            // Determine HTTP method based on existence of record
            const method = isExistingRecord ? 'PUT' : 'POST';
            const url = isExistingRecord ? http ://localhost:3000/api/plants/${data.UNIT_NAME} : 'http://localhost:3000/api/plants';

                // API呼び出し
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(result => {
                        alert('入力が完了しました');
                        // 入力フィールドをクリア
                        document.getElementById('adminForm').reset();
                        isExistingRecord = false; // Reset the flag
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to save data.');
                    });
        }

        function navigateToListPage() {
            window.location.href = 'list.html'; // Adjust the file name if needed
        }
        function navigateToListPage() {
            window.location.href = 'list.html'; // Adjust the file name if needed
        }
    </script>
</body>

</html>